---
title: "Jasens_Workspace"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
get_plots <- function(name,count, graphs){
  graph_count <- count
  index <- 0
  lay1 <- rbind(c(1, NA),
                c(NA, NA))
  lay2 <- rbind(c(1, 2),
                c(NA, NA))
  lay3 <- rbind(c(1, 2),
                c(3, NA))  
  lay4 <- rbind(c(1,2),
                c(3,4))
  
  pdf(name) 
  while(graph_count > 0){
    if(graph_count == 1){
      grid.arrange(graphs[[1+index]], layout_matrix = lay1)      
    } else if(graph_count == 2){
      grid.arrange(graphs[[1+index]], 
                   graphs[[2+index]], layout_matrix = lay2)      
    } else if(graph_count == 3){
      grid.arrange(graphs[[1+index]], 
                   graphs[[2+index]], 
                   graphs[[3+index]], layout_matrix = lay3)      
    } else{
      grid.arrange(graphs[[1+index]], 
                   graphs[[2+index]], 
                   graphs[[3+index]], 
                   graphs[[4+index]], layout_matrix = lay4)      
    }
    graph_count <- graph_count - 4
    index <- index + 4
  }
  dev.off()
}
```

# 0 count how many variables are missing

```{r}
df <- read.csv('cancer_registry.csv')

colSums(is.na(df))
```

We realize we can easily impute for # college 18-24 since it needs to add to 100% with the other 18-24 groups.

## 1. Preliminary Regression

Here, I examine variables one at a time

```{r cars}
library(tidyverse)
library(gridExtra)
df <- read.csv('cancer_registry.csv') %>%
  filter(incidenceRate < 1000) %>%
  filter(avgAnnCount < 20000) %>%
  filter(MedianAge < 200) %>%
  filter(AvgHouseholdSize > 1)

graphs <- list()
graph_count <- 1

vars <- colnames(df)
misc_vars <- c('binnedInc', 'Geography', 'TARGET_deathRate')
vars_1 <- setdiff(vars, misc_vars)
var_explained_1 <- c()

for(i in vars_1){
  eq <- paste('TARGET_deathRate', i, sep = ' ~ ')
  m1 <- lm(formula = eq, data = df)
  s1 <- summary(m1)
  var_explained_1 <- append(var_explained_1, s1$r.squared)
  coeffs <- as.numeric(m1$coefficients)
  x_temp <- dplyr::pull(df, i)
  y_hat <- x_temp  * coeffs[2] + coeffs[1]
  
  df_hat <- data.frame(y_hat, x_temp)
  g <- ggplot() + geom_point(data = df, aes(x = !!as.name(i), y = TARGET_deathRate)) + 
  geom_line(data = df_hat, aes(x = x_temp, y = y_hat))
  
  g
  graphs[[graph_count]] <- g
  graph_count <- graph_count + 1
}

var_explained_df_1 <- data.frame(vars_1, var_explained_1)

get_plots('Jasen_1_Individual_Plots.pdf', graph_count - 1, graphs)

```


# 2 Preliminary Log Regression

A few variables may look better with a log x axis

```{r}
log_vars <- c('avgAnnCount', 'avgDeathsPerYear', 'popEst2015', 'studyPerCap', 'PctBachDeg18_24', 'PctAsian', 'PctOtherRace')
log_names <- c()
graph_count <- 1
graphs <- list()
var_explained_2 <- c()
for(i in log_vars){
  temp <- paste(i, '_log', sep = '')
  
  log_names <- append(log_names, temp)
  if(i %in% c('studyPerCap')){
    df <- df %>% mutate(!!as.name(temp) := log(!!as.name(i) + 1))
  } else if(i %in% c('PctAsian', 'PctBachDeg18_24', 'PctOtherRace')){
    df <- df %>% mutate(!!as.name(temp) := log(!!as.name(i) + exp(-5)))
  } else{
    df <- df %>% mutate(!!as.name(temp) := log(!!as.name(i)))
  }
  
  
  eq <- paste('TARGET_deathRate', temp, sep = ' ~ ')
  m2 <- lm(formula = eq, data = df)
  s2 <- summary(m2)
  var_explained_2 <- append(var_explained_2, s2$r.squared)
  coeffs <- as.numeric(m2$coefficients)
  x_temp <- dplyr::pull(df, temp)
  y_hat <- x_temp  * coeffs[2] + coeffs[1]
  
  df_hat <- data.frame(y_hat, x_temp)
  g <- ggplot() + geom_point(data = df, aes(x = !!as.name(temp), y = TARGET_deathRate)) + 
  geom_line(data = df_hat, aes(x = x_temp, y = y_hat))
  
  graphs[[graph_count]] <- g
  graph_count <- graph_count + 1
}

get_plots('Jasen_2_Log_Individual_Plots.pdf', graph_count - 1, graphs)


var_explained_df_2 <- data.frame(log_names, var_explained_2)
```

# 3 Look at all variables together

```{r}
dep_var <- c('TARGET_deathRate')
all_vars <- setdiff(vars_1, log_vars)
all_vars <- append(all_vars, log_names)
all_vars <- sort(all_vars)
eq3 <- paste(all_vars, collapse = ' + ')
eq3 <- paste(dep_var, eq3, sep = ' ~ ')

m3 <- lm(eq3, data = df)
s3 <- summary(m3)
s3

p_values <- unname(s3$coefficients[,4])
p_values <- p_values[2:length(p_values)]
var_summary <- data.frame(all_vars, p_values)

colnames(var_explained_df_2) <- colnames(var_explained_df_1)
var_explained_df_3 <- rbind(var_explained_df_1, var_explained_df_2)
colnames(var_explained_df_3) <- c('all_vars', 'var_explained')

var_summary <- var_summary %>% left_join(var_explained_df_3, by = 'all_vars')
```

# 4 Heatmap

We have a decent ranking of the variables with criteria being p-value and % variance explained. We now look into variables that have high mutual correlation

```{r}

col1 <- c()
col2 <- c()
corr_col <- c()

for(i in all_vars){
  for(j in all_vars){
    col1 <- append(col1, i)
    col2 <- append(col2, j)
    x <- dplyr::pull(df, i)
    y <- dplyr::pull(df, j)
    
    temp_df <- data.frame(x,y) 
    temp_df <- na.omit(temp_df)
    
    temp_cor <- cor(temp_df$x, temp_df$y, method = 'pearson')
    corr_col <- append(corr_col, temp_cor)
  }
}

df4 <- data.frame(col1, col2, corr_col)

g4 <- ggplot() + geom_tile(aes(x = col1, y = col2, fill = corr_col)) + 
  theme(axis.text.x = element_text(angle = 90))


pdf('Jasen_heatmap1.pdf')
g4
dev.off()

#another heatmap option

df_temp <- df %>% select(all_vars)
df_temp <- na.omit(df_temp)

heatmap2 <- cor(df_temp)

pdf('Jasen_heatmap2.pdf')
heatmap(heatmap2)
dev.off()

```

# 5 Carefully choosing variables for our model

```{r}
choose_pvalue <- var_summary %>% filter(p_values < 10^(-4)) %>%
  select(all_vars)

choose_pvalue <- unname(unlist(choose_pvalue))


eq5 <- paste(choose_pvalue, collapse = ' + ')
eq5 <- paste(dep_var, eq5, sep= ' ~ ')

m5 <- lm(eq5, data = df)
s5 <- summary(m5)
s5
```

# 6 Using PCA 

```{r}
all_vars_and_dep <- append(all_vars, dep_var)
df6 <- df %>% select(all_vars) 
df6 <- na.omit(df6)
m6 <- prcomp(df6)
s6 <- summary(m6)

component_matrix <- data.frame(as.matrix(df6) %*% m6$rotation)

pca_df <- component_matrix %>% mutate(dep_var = )

```
